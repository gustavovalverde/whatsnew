# Release Workflow (Step 1 of 2)
#
# Trigger: Push to main (or manual dispatch)
#
# What it does:
#   1. Runs tests, lint, build, typecheck
#   2. If changesets exist → creates "Version Packages" PR
#   3. If PR merged → publishes to NPM + creates GitHub releases
#   4. Triggers build-binaries.yml via workflow_dispatch for CLI releases

name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    environment:
      name: release
      url: https://www.npmjs.com/package/@whatsnew/cli
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: "1.3.1"

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify build
        run: |
          bun run lint
          bun run build
          bun run typecheck
          bun run test

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba # v1.5.3
        with:
          publish: bun run ci:publish
          version: bun run ci:version
          commit: "chore(release): version packages"
          title: "chore(release): version packages"
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: "true"

      - name: Log published packages
        if: steps.changesets.outputs.published == 'true'
        run: echo "Published:" && echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | "  - \(.name)@\(.version)"'

      - name: Trigger binary builds for CLI releases
        if: steps.changesets.outputs.published == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract CLI package releases and trigger binary builds
          echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | select(.name == "@whatsnew/cli") | "@whatsnew/cli@\(.version)"' | while read -r tag; do
            echo "Triggering build-binaries for: $tag"
            gh workflow run build-binaries.yml --ref main -f tag="$tag"
          done
