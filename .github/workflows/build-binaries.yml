# Build Binaries Workflow (Step 2 of 2)
#
# Trigger: Workflow dispatch from release.yml (or manual dispatch)
#
# Jobs:
#   1. build:           Compile binaries for all platforms (parallel matrix)
#   2. publish:         Upload binaries + checksums to GitHub release
#   3. update-homebrew: Update formula with SHA256s (only for @whatsnew/cli@ tags)
#
# Local testing:
#   bun run build
#   VERSION=$(node -p "require('./packages/cli/package.json').version")
#   bun build --compile packages/cli/bin/whatsnew.ts --outfile whatsnew --define "__VERSION__='$VERSION'"
#   ./whatsnew --version

name: Build Binaries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build and publish to (e.g., @whatsnew/cli@1.0.0)"
        required: true
        type: string

concurrency:
  group: build-binaries-${{ inputs.tag }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: bun-linux-x64
            runner: ubuntu-24.04
            artifact: whatsnew-linux-x64
          - target: bun-linux-arm64
            runner: ubuntu-24.04-arm
            artifact: whatsnew-linux-arm64
          - target: bun-darwin-x64
            runner: macos-13
            artifact: whatsnew-darwin-x64
          - target: bun-darwin-arm64
            runner: macos-14
            artifact: whatsnew-darwin-arm64
          - target: bun-windows-x64
            runner: windows-latest
            artifact: whatsnew-windows-x64.exe
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          ref: ${{ inputs.tag }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: "1.3.1"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Build binary
        shell: bash
        run: |
          VERSION=$(node -p "require('./packages/cli/package.json').version")
          bun build --compile --target=${{ matrix.target }} packages/cli/bin/whatsnew.ts --outfile ${{ matrix.artifact }} --define "__VERSION__='$VERSION'"

      - name: Test binary (Unix)
        if: runner.os != 'Windows'
        run: ./${{ matrix.artifact }} --help

      - name: Test binary (Windows)
        if: runner.os == 'Windows'
        run: .\${{ matrix.artifact }} --help

      - name: Generate checksum (Unix)
        if: runner.os != 'Windows'
        run: sha256sum ${{ matrix.artifact }} > ${{ matrix.artifact }}.sha256

      - name: Generate checksum (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Algorithm SHA256 ${{ matrix.artifact }}).Hash.ToLower()
          "$hash  ${{ matrix.artifact }}" | Out-File -Encoding utf8 ${{ matrix.artifact }}.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}
            ${{ matrix.artifact }}.sha256
          if-no-files-found: error

  publish:
    name: Publish to Release
    runs-on: ubuntu-24.04
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: binaries
          merge-multiple: true

      - name: Verify checksums exist
        run: |
          cd binaries && ls -la
          # Every binary must have a matching .sha256 file
          for f in whatsnew-*; do
            case "$f" in *.sha256) continue ;; esac
            [ -f "$f.sha256" ] || { echo "::error::Missing checksum for $f"; exit 1; }
          done

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ inputs.tag }}
          files: binaries/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create job summary
        run: |
          echo "## Binaries published" >> $GITHUB_STEP_SUMMARY
          ls binaries/ | grep -v '\.sha256$' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-24.04
    if: startsWith(inputs.tag, '@whatsnew/cli@')
    needs: publish
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: "1.3.1"

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ inputs.tag }}"
          echo "version=${TAG#@whatsnew/cli@}" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: bun run scripts/update-homebrew-formula.ts ${{ steps.version.outputs.version }}

      - name: Validate formula
        run: |
          # Check no placeholders remain
          if grep -q 'PLACEHOLDER_' HomebrewFormula/whatsnew.rb; then
            echo "Error: Placeholders not replaced in formula"
            exit 1
          fi

          # Verify all SHA256 values are valid (64 lowercase hex chars)
          sha256_count=$(grep -oE 'sha256 "[a-f0-9]{64}"' HomebrewFormula/whatsnew.rb | wc -l)
          if [ "$sha256_count" -lt 4 ]; then
            echo "Error: Expected 4 SHA256 values, found $sha256_count"
            exit 1
          fi

          # Check Ruby syntax
          ruby -c HomebrewFormula/whatsnew.rb

          echo "Formula validation passed"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add HomebrewFormula/whatsnew.rb
          git diff --staged --quiet || git commit -m "chore(homebrew): update formula for v${{ steps.version.outputs.version }}"
          git push
