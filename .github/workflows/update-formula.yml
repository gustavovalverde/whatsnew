name: Update Homebrew Formula

on:
  workflow_run:
    workflows: ["Build Binaries"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update formula for (e.g., 0.1.0)"
        required: true

permissions:
  contents: read

jobs:
  update-formula:
    name: Update Formula SHA256
    runs-on: ubuntu-latest
    # Only run if: 1) manual trigger, or 2) build succeeded AND from same repo (not fork)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.repository.full_name == github.repository)
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Get version and tag
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Find the latest @whatsnew/cli release
            TAG=$(gh release list --limit 20 | grep "@whatsnew/cli@" | head -1 | awk '{print $1}')
            VERSION=$(echo "$TAG" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          fi

          # SECURITY: Validate version format (semver only, no special chars)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi

          TAG="@whatsnew/cli@${VERSION}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION, tag: $TAG"

      - name: Download SHA256 files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          mkdir -p checksums
          # Download checksum files from the release
          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            gh release download "${TAG}" \
              --pattern "whatsnew-${platform}.sha256" \
              --dir ./checksums \
              || echo "Warning: Could not download whatsnew-${platform}.sha256"
          done
          ls -la checksums/ || echo "No checksums downloaded"

      - name: Validate and update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          FORMULA="Formula/whatsnew.rb"

          # SECURITY: Validate all SHA256 values before using them
          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            if [ -f "checksums/whatsnew-${platform}.sha256" ]; then
              SHA=$(awk '{print $1}' "checksums/whatsnew-${platform}.sha256")
              # Validate SHA256 format (exactly 64 hex characters)
              if ! echo "$SHA" | grep -qE '^[a-f0-9]{64}$'; then
                echo "::error::Invalid SHA256 for ${platform}: $SHA"
                exit 1
              fi
            fi
          done

          # Update version using Ruby for safe string handling
          ruby -i -pe "gsub(/version \".*\"/, 'version \"'+'$VERSION'+'\"')" "$FORMULA"

          # Update SHA256 for each platform
          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            if [ -f "checksums/whatsnew-${platform}.sha256" ]; then
              SHA=$(awk '{print $1}' "checksums/whatsnew-${platform}.sha256")
              PLACEHOLDER="SHA256_$(echo "$platform" | tr '[:lower:]-' '[:upper:]_')"
              # Use Ruby for safe string replacement
              ruby -i -pe "gsub(/sha256 \"${PLACEHOLDER}\"/, 'sha256 \"${SHA}\"')" "$FORMULA"
              ruby -i -pe "gsub(/sha256 \"[a-f0-9]{64}\"/, 'sha256 \"${SHA}\"') if \$_.include?('${platform}')" "$FORMULA"
            fi
          done

          echo "Updated formula:"
          cat "$FORMULA"

          # Validate formula syntax
          ruby -c "$FORMULA"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(formula): update whatsnew to v${{ steps.version.outputs.version }}"
          title: "chore(formula): update whatsnew to v${{ steps.version.outputs.version }}"
          body: |
            Updates Homebrew formula for whatsnew v${{ steps.version.outputs.version }}

            This PR was automatically created by the update-formula workflow.

            **Security checklist:**
            - [ ] SHA256 checksums match release artifacts
            - [ ] Version matches expected release
          branch: formula/v${{ steps.version.outputs.version }}
          delete-branch: true
          labels: |
            automated
            homebrew
